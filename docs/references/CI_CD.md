# 持续集成与部署文档

本文档介绍交易系统的CI/CD流程和最佳实践。

## CI/CD 流程概述

系统使用GitHub Actions实现自动化CI/CD流程，包括三个主要步骤：

1. **代码质量检查和测试** - 运行单元测试、代码格式和语法检查
2. **构建Docker镜像** - 构建并推送到GitHub容器注册表(GHCR)
3. **镜像验证测试** - 验证构建的镜像能够正常运行和通过健康检查

## GitHub Actions 工作流

### 触发条件

CI/CD流程在以下情况下触发：

1. 推送代码到`main`或`develop`分支
2. 创建以"v"开头的标签（用于版本发布）
3. 创建针对`main`或`develop`分支的Pull Request
4. 手动触发（通过GitHub Actions界面）

### 工作流步骤

#### 1. 代码质量检查和测试

- **代码格式化检查** - 使用Black确保代码风格一致
- **导入顺序检查** - 使用isort检查导入语句顺序
- **代码语法检查** - 使用flake8进行静态代码分析
- **单元测试** - 使用pytest运行所有测试用例

#### 2. Docker镜像构建和推送

- **登录容器注册表** - 登录到GitHub容器注册表
- **提取元数据** - 生成适当的镜像标签和标签
- **构建和推送** - 构建Docker镜像并推送到注册表
  - 推送仅在直接提交到分支（非PR）时执行
  - 标签基于分支名、PR编号或语义化版本标签

#### 3. 镜像验证测试

- **拉取镜像** - 从注册表拉取刚构建的镜像
- **启动容器** - 使用测试配置启动容器
- **验证健康状态** - 等待容器达到健康状态
- **测试功能** - 验证关键功能和API端点

## 版本控制与发布

### 语义化版本

系统使用语义化版本控制：

- **主版本号(X)** - 不兼容的API变更
- **次版本号(Y)** - 向后兼容的功能性新增
- **修订号(Z)** - 向后兼容的问题修正

### 发布流程

1. 在`develop`分支开发和测试新功能
2. 创建Pull Request合并到`main`分支
3. 合并后，为稳定版本创建标签（如`v1.2.3`）
4. GitHub Actions自动构建并发布该版本的Docker镜像

## 镜像标签策略

CI/CD流程生成以下Docker镜像标签：

- **语义化版本标签** - 如`v1.2.3`、`v1.2`（主要版本和次版本）
- **分支标签** - 如`main`、`develop`
- **提交哈希标签** - 如`sha-a1b2c3d`（用于精确追踪）
- **PR标签** - 如`pr-123`（用于测试PR变更）

## 在本地运行CI检查

开发人员可在提交前在本地运行相同的检查：

```bash
# 安装开发依赖
pip install pytest flake8 black isort

# 运行代码格式检查
black --check scripts/
isort --check scripts/

# 运行语法检查
flake8 scripts/

# 运行测试
pytest
```

## 生产部署最佳实践

### 蓝绿部署

使用蓝绿部署策略实现零停机升级：

1. 部署新版本（绿色环境）
2. 验证新版本功能正常
3. 切换流量到新版本
4. 移除旧版本（蓝色环境）

### 回滚策略

如果部署后发现问题：

1. 立即将流量切回上一个稳定版本
2. 在GitHub上创建回滚提交或还原PR
3. 分析问题原因并在develop分支修复

### 监控与告警

部署后监控关键指标：

1. **错误率** - 系统错误计数突增
2. **心跳延迟** - 心跳年龄超过阈值
3. **内存使用** - 内存使用异常增长
4. **交易处理** - 交易计数异常下降

## 安全最佳实践

### 凭证管理

- 不在代码中存储凭证
- 使用GitHub Secrets存储敏感信息
- 在生产环境使用环境变量或安全的配置管理工具

### 镜像安全

- 定期更新基础镜像
- 使用轻量级基础镜像减少攻击面
- 以非root用户运行容器

### 依赖管理

- 固定依赖版本号
- 定期更新依赖
- 使用GitHub的依赖扫描工具 