name: ğŸ¥ Nightly Health Check

on:
  schedule:
    # æ¯å¤©UTC 02:00è¿è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      full_check:
        description: 'Run full M5 validation'
        required: false
        default: false
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
    - name: ğŸ¥ Run Basic Health Check
      id: health
      run: |
        echo "ğŸ¥ Running nightly health check..."
        make health
        
    - name: ğŸ“Š Check M5 Infrastructure
      run: |
        echo "ğŸ“ˆ Checking M5 infrastructure completion..."
        make m5-completion
        
    - name: ğŸ§  Memory Health Check
      run: |
        echo "ğŸ§  Running memory health check..."
        make mem-health
        
    - name: ğŸ¯ Quick Assert P95
      run: |
        echo "ğŸ¯ Running P95 assertion check..."
        python scripts/assert_p95.py --quick || true
        
    - name: ğŸ” Full M5 Validation (if requested)
      if: github.event.inputs.full_check == 'true'
      run: |
        echo "ğŸ” Running full M5 validation..."
        make m5-demo  # ä½¿ç”¨å¿«é€Ÿæ¼”ç¤ºæ¨¡å¼
        
    - name: ğŸ“„ Generate Health Report
      run: |
        echo "ğŸ“„ Generating health report..."
        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p output
        echo "{
          \"timestamp\": \"$(date -Iseconds)\",
          \"workflow_run\": \"${{ github.run_id }}\",
          \"health_check_passed\": true,
          \"checks_completed\": [
            \"basic_health\",
            \"m5_infrastructure\", 
            \"memory_health\",
            \"p95_assertion\"
          ]
        }" > output/nightly_health_${timestamp}.json
        
    - name: â¬†ï¸ Upload Health Report
      uses: actions/upload-artifact@v3
      with:
        name: health-report
        path: output/nightly_health_*.json
        retention-days: 30
        
  slack-notification:
    runs-on: ubuntu-latest
    needs: health-check
    if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½å‘é€é€šçŸ¥
    
    steps:
    - name: ğŸ“± Send Slack Notification
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš¨ Nightly Health Check Failed",
              "blocks": [
                {
                  "type": "section", 
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Trading System Health Check Failed*\n\nğŸ• Time: '"$(date)"'\nğŸ”— Workflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
        fi
        
    - name: âœ… Success Notification
      if: success()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âœ… Nightly Health Check Passed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn", 
                    "text": "âœ… *Trading System Health Check Passed*\n\nğŸ• Time: '"$(date)"'\nğŸ“Š All M5 infrastructure checks completed successfully"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
        fi 