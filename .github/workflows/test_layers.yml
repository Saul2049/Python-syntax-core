name: åˆ†å±‚æµ‹è¯• Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡ŒéªŒæ”¶æµ‹è¯•

jobs:
  # ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿæµ‹è¯• (å•å…ƒæµ‹è¯•)
  fast_tests:
    name: ğŸš€ å¿«é€Ÿæµ‹è¯• (å•å…ƒæµ‹è¯•)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
        
    - name: è¿è¡Œå¿«é€Ÿæµ‹è¯•
      run: |
        pytest tests/ \
          -m "unit and not slow" \
          --maxfail=5 \
          --tb=short \
          --durations=5 \
          -v
          
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: fast-test-results
        path: test-results/

  # ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
  core_tests:
    name: ğŸ§  æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•  
    runs-on: ubuntu-latest
    needs: fast_tests
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡Œæ ¸å¿ƒæµ‹è¯•
      run: |
        pytest tests/ \
          -m "core or smoke" \
          --cov=src \
          --cov-report=xml \
          --cov-fail-under=75 \
          -v
          
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  # ç¬¬ä¸‰å±‚ï¼šé›†æˆæµ‹è¯•
  integration_tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: core_tests
    timeout-minutes: 30
    
    strategy:
      matrix:
        test_group: [trading, data, network, monitoring]
        
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡Œé›†æˆæµ‹è¯• - ${{ matrix.test_group }}
      run: |
        pytest tests/ \
          -m "integration and ${{ matrix.test_group }}" \
          --tb=short \
          -v

  # ç¬¬å››å±‚ï¼šæ…¢é€Ÿæµ‹è¯• (åªåœ¨mainåˆ†æ”¯è¿è¡Œ)
  slow_tests:
    name: ğŸŒ æ…¢é€Ÿæµ‹è¯•
    runs-on: ubuntu-latest
    needs: integration_tests
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 60
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡Œæ…¢é€Ÿæµ‹è¯•
      run: |
        pytest tests/ \
          -m "slow" \
          --tb=short \
          -v

  # éªŒæ”¶æµ‹è¯• (æ¯æ—¥å®šæ—¶è¿è¡Œ)
  acceptance_tests:
    name: âœ… éªŒæ”¶æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 90
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡ŒéªŒæ”¶æµ‹è¯•
      run: |
        pytest tests/ \
          -m "acceptance" \
          --cov=src \
          --cov-report=html \
          -v
          
    - name: ä¸Šä¼ å®Œæ•´æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: acceptance-test-report
        path: htmlcov/

# å®šæ—¶è¿è¡ŒéªŒæ”¶æµ‹è¯•å·²åœ¨ä¸Šé¢çš„onéƒ¨åˆ†é…ç½® 