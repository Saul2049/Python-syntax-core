groups:
  - name: trading_system_alerts
    rules:
      # ğŸš¨ é«˜å»¶è¿Ÿå‘Šè­¦
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(signal_latency_seconds_bucket[5m])) > 0.0055
        for: 3m
        labels:
          severity: warning
          component: latency
          team: trading
        annotations:
          summary: "Trading signal latency too high"
          description: "P95 latency {{ $value }}s exceeds 5.5ms threshold for {{ $labels.instance }}"
          runbook_url: "docs/MONITORING.md#æ•…éšœåœºæ™¯1-é«˜å»¶è¿Ÿå‘Šè­¦-highlatency"

      # ğŸ§  å†…å­˜æ³„æ¼å‘Šè­¦
      - alert: MemoryLeak
        expr: increase(process_memory_rss_bytes[30m]) > 62914560  # 60MB
        for: 5m
        labels:
          severity: critical
          component: memory
          team: trading
        annotations:
          summary: "Memory leak detected"
          description: "RSS memory increased by {{ $value | humanize1024 }} in 30 minutes on {{ $labels.instance }}"
          runbook_url: "docs/MONITORING.md#æ•…éšœåœºæ™¯2-å†…å­˜æ³„æ¼-memoryleak"

      # ğŸ§  å†…å­˜ä½¿ç”¨è¿‡é«˜å‘Šè­¦
      - alert: HighMemoryUsage
        expr: process_memory_rss_bytes / 1024 / 1024 > 60  # 60MB
        for: 3m
        labels:
          severity: warning
          component: memory
          team: trading
        annotations:
          summary: "Memory usage too high"
          description: "RSS memory {{ $value | printf \"%.1f\" }}MB exceeds 60MB threshold on {{ $labels.instance }}"

      # ğŸ—‘ï¸ GCæ€§èƒ½å‘Šè­¦
      - alert: GCPerformanceDegraded
        expr: histogram_quantile(0.95, rate(gc_pause_duration_seconds_bucket[10m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: gc
          team: trading
        annotations:
          summary: "GC pause time too high"
          description: "GC P95 pause time {{ $value | printf \"%.3f\" }}s exceeds 50ms threshold on {{ $labels.instance }}"
          runbook_url: "docs/MONITORING.md#æ•…éšœåœºæ™¯3-gcæ€§èƒ½æ¶åŒ–-gcperformancedegraded"

      # ğŸ”— æ–‡ä»¶æè¿°ç¬¦æ³„æ¼å‘Šè­¦
      - alert: FileDescriptorLeak
        expr: process_open_fds > 800
        for: 3m
        labels:
          severity: warning
          component: system
          team: trading
        annotations:
          summary: "File descriptor count too high"
          description: "Open FDs: {{ $value }} > 800 threshold on {{ $labels.instance }}"
          runbook_url: "docs/MONITORING.md#æ•…éšœåœºæ™¯4-æ–‡ä»¶æè¿°ç¬¦æ³„æ¼-filedescriptorleak"

      # ğŸ”— æ–‡ä»¶æè¿°ç¬¦å¢é•¿ç‡å‘Šè­¦
      - alert: FileDescriptorGrowthRate
        expr: rate(process_open_fds[10m]) * 60 > 5  # æ¯åˆ†é’Ÿå¢é•¿>5ä¸ª
        for: 5m
        labels:
          severity: warning
          component: system
          team: trading
        annotations:
          summary: "File descriptor growth rate too high"
          description: "FD growth rate {{ $value | printf \"%.1f\" }}/min exceeds 5/min threshold on {{ $labels.instance }}"

      # ğŸ“Š æ•°æ®æºæ–­çº¿å‘Šè­¦
      - alert: DataSourceDown
        expr: data_source_status == 0
        for: 1m
        labels:
          severity: critical
          component: data_source
          team: trading
        annotations:
          summary: "Data source unavailable"
          description: "Data source {{ $labels.source_name }} is down on {{ $labels.instance }}"

      # âŒ é”™è¯¯ç‡æ¿€å¢å‘Šè­¦
      - alert: HighErrorRate
        expr: increase(trading_error_count_total[10m]) > 5
        for: 2m
        labels:
          severity: warning
          component: errors
          team: trading
        annotations:
          summary: "High error rate detected"
          description: "{{ $value }} errors in last 10 minutes on {{ $labels.instance }}"

      # ğŸ’” å¿ƒè·³è¶…æ—¶å‘Šè­¦
      - alert: HeartbeatTimeout
        expr: trading_heartbeat_age_seconds > 180
        for: 3m
        labels:
          severity: critical
          component: heartbeat
          team: trading
        annotations:
          summary: "Trading system heartbeat timeout"
          description: "No heartbeat for {{ $value }}s (>180s threshold) on {{ $labels.instance }}"

      # ğŸ§  å†…å­˜å¢é•¿ç‡å‘Šè­¦
      - alert: MemoryGrowthRate
        expr: rate(process_memory_rss_bytes[10m]) * 60 / 1024 / 1024 > 2  # >2MB/min
        for: 10m
        labels:
          severity: warning
          component: memory
          team: trading
        annotations:
          summary: "Memory growth rate too high"
          description: "Memory growing at {{ $value | printf \"%.1f\" }}MB/min (>2MB/min threshold) on {{ $labels.instance }}"

  - name: trading_system_critical_alerts
    rules:
      # ğŸš¨ ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
      - alert: TradingSystemDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          component: system
          team: trading
        annotations:
          summary: "Trading system is down"
          description: "Trading system {{ $labels.instance }} is completely unavailable"

      # ğŸš¨ Prometheusç›‘æ§ä¸å¯ç”¨
      - alert: PrometheusMetricsUnavailable
        expr: absent(process_memory_rss_bytes)
        for: 5m
        labels:
          severity: critical
          component: monitoring
          team: devops
        annotations:
          summary: "Prometheus metrics unavailable"
          description: "Core system metrics are not being collected"

  - name: trading_system_m5_validation
    rules:
      # ğŸ¯ W1ç¼“å­˜ä¼˜åŒ–éªŒè¯
      - alert: W1CacheOptimizationFailed
        expr: memory_allocation_rate_mb_per_minute > 10  # åˆ†é…ç‡>10MB/min
        for: 15m
        labels:
          severity: warning
          component: w1_cache
          team: trading
        annotations:
          summary: "W1 cache optimization not effective"
          description: "Memory allocation rate {{ $value | printf \"%.1f\" }}MB/min exceeds 10MB/min after W1 optimization"

      # ğŸ¯ W2 GCä¼˜åŒ–éªŒè¯
      - alert: W2GCOptimizationFailed
        expr: histogram_quantile(0.95, rate(gc_pause_duration_seconds_bucket[1h])) > 0.05
        for: 1h
        labels:
          severity: warning
          component: w2_gc
          team: trading
        annotations:
          summary: "W2 GC optimization not effective"
          description: "GC P95 pause time {{ $value | printf \"%.3f\" }}s still exceeds 50ms after W2 optimization"

      # ğŸ¯ W3æ³„æ¼æ£€æµ‹éªŒè¯
      - alert: W3LeakDetectionFailed
        expr: increase(leaked_objects_total[6h]) > 0
        for: 1m
        labels:
          severity: critical
          component: w3_leak
          team: trading
        annotations:
          summary: "W3 leak detection failed - objects leaked"
          description: "{{ $value }} objects leaked in the last 6 hours, violating W3 leak-free requirement"

      # ğŸ¯ W4å‹åŠ›æµ‹è¯•éªŒè¯
      - alert: W4StressTestFailed
        expr: |
          (
            process_memory_rss_bytes / 1024 / 1024 > 40 or
            histogram_quantile(0.95, rate(signal_latency_seconds_bucket[1h])) > 0.0055 or
            histogram_quantile(0.95, rate(gc_pause_duration_seconds_bucket[1h])) > 0.05
          )
        for: 5m
        labels:
          severity: critical
          component: w4_stress
          team: trading
        annotations:
          summary: "W4 stress test requirements not met"
          description: "One or more W4 requirements violated: RSS>40MB, P95 latency>5.5ms, or GC pause>50ms" 