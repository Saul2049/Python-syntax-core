groups:
  - name: trading_performance_baseline
    interval: 10s
    rules:
      # M3é˜¶æ®µæ€§èƒ½åŸºçº¿è®°å½•è§„åˆ™
      - record: signal_latency_p95_1d
        expr: histogram_quantile(0.95, rate(trading_signal_latency_seconds_bucket[1d]))
        labels:
          phase: "m3_baseline"
          
      - record: signal_latency_p99_1d  
        expr: histogram_quantile(0.99, rate(trading_signal_latency_seconds_bucket[1d]))
        labels:
          phase: "m3_baseline"
          
      - record: order_latency_p95_1d
        expr: histogram_quantile(0.95, rate(trading_order_latency_seconds_bucket[1d]))
        labels:
          phase: "m3_baseline"
          
      # ååé‡æŒ‡æ ‡
      - record: trading_throughput_cps
        expr: rate(trading_signal_latency_seconds_count[5m])
        labels:
          phase: "m3_baseline"
          
      # é”™è¯¯ç‡æŒ‡æ ‡  
      - record: trading_error_rate_5m
        expr: rate(trading_exceptions_total[5m])
        labels:
          phase: "m3_baseline"

  - name: trading_performance_alerts
    rules:
      # æ€§èƒ½å›å½’å‘Šè­¦è§„åˆ™
      - alert: HighSignalLatency
        expr: signal_latency_p95_1d > 0.010  # 10msé˜ˆå€¼
        for: 5m
        labels:
          severity: warning
          team: trading
        annotations:
          summary: "äº¤æ˜“ä¿¡å·å»¶è¿Ÿè¿‡é«˜"
          description: "P95ä¿¡å·å»¶è¿Ÿ {{ $value }}s è¶…è¿‡10msé˜ˆå€¼"
          
      - alert: PerformanceRegression
        expr: (signal_latency_p95_1d / signal_latency_p95_1d offset 1d) > 1.2
        for: 15m
        labels:
          severity: critical
          team: trading
        annotations:
          summary: "æ€§èƒ½å›å½’æ£€æµ‹"
          description: "P95å»¶è¿Ÿç›¸æ¯”æ˜¨å¤©å¢åŠ äº† {{ printf \"%.1f\" (($value - 1) * 100) }}%"
          
      - alert: LowThroughput
        expr: trading_throughput_cps < 0.1  # ä½äº0.1 cycles/sec
        for: 10m
        labels:
          severity: warning
          team: trading
        annotations:
          summary: "äº¤æ˜“ååé‡è¿‡ä½"
          description: "å½“å‰ååé‡ {{ $value }} cycles/sec è¿‡ä½" 

# ğŸ”¥ W2 GCä¼˜åŒ–å‘Šè­¦è§„åˆ™
- name: w2_gc_optimization_alerts
  rules:
  # W2 GCé…ç½®åç¦»æ£€æµ‹
  - alert: W2_GC_Config_Drift
    expr: gc_threshold_gen0 != 900 or gc_threshold_gen1 != 20 or gc_threshold_gen2 != 10
    for: 1m
    labels:
      severity: warning
      component: gc_config
      phase: w2
    annotations:
      summary: "GCé…ç½®åç¦»W2æœ€ä¼˜å€¼"
      description: "å½“å‰GCé˜ˆå€¼ä¸æ˜¯W2éªŒè¯çš„æœ€ä¼˜é…ç½®(900,20,10)"
      
  # W2 GCæ€§èƒ½å›é€€æ£€æµ‹
  - alert: W2_GC_Performance_Regression
    expr: histogram_quantile(0.95, gc_pause_duration_seconds) > 0.05
    for: 2m
    labels:
      severity: critical
      component: gc_performance
      phase: w2
    annotations:
      summary: "GCæ€§èƒ½å›é€€ï¼Œè¶…è¿‡W2é˜ˆå€¼"
      description: "GCæš‚åœP95 {{ $value }}s è¶…è¿‡50msï¼ŒW2ä¼˜åŒ–æ•ˆæœæ¶ˆå¤±"
      
  # Gen0è§¦å‘é¢‘ç‡å¼‚å¸¸
  - alert: W2_Gen0_Frequency_High
    expr: rate(gc_collections_total{generation="0"}[5m]) > 0.05
    for: 5m
    labels:
      severity: warning
      component: gc_gen0
      phase: w2
    annotations:
      summary: "Gen0 GCè§¦å‘é¢‘ç‡å¼‚å¸¸"
      description: "Gen0è§¦å‘ç‡ {{ $value }}/5min è¶…è¿‡W2é¢„æœŸï¼Œåº”æ¥è¿‘0"
      
  # Gen2è§¦å‘é¢‘ç‡å¼‚å¸¸ 
  - alert: W2_Gen2_Frequency_High
    expr: rate(gc_collections_total{generation="2"}[5m]) > 0.05
    for: 5m
    labels:
      severity: warning  
      component: gc_gen2
      phase: w2
    annotations:
      summary: "Gen2 GCè§¦å‘é¢‘ç‡å¼‚å¸¸"
      description: "Gen2è§¦å‘ç‡ {{ $value }}/5min è¶…è¿‡W2é¢„æœŸï¼Œåº”æ¥è¿‘0"

- name: m5_memory_alerts
  rules:
  # RSS Memory Alerts
  - alert: MemoryUsageHigh
    expr: process_memory_rss_bytes > 60 * 1024 * 1024
    for: 5m
    labels:
      severity: warning
      component: memory
      phase: m5
    annotations:
      summary: "å†…å­˜ä½¿ç”¨è¿‡é«˜"
      description: "RSSå†…å­˜ä½¿ç”¨é‡ {{ $value | humanize1024 }}B è¶…è¿‡60MBé˜ˆå€¼ï¼ŒæŒç»­5åˆ†é’Ÿ"
      
  - alert: MemoryUsageCritical
    expr: process_memory_rss_bytes > 80 * 1024 * 1024
    for: 1m
    labels:
      severity: critical
      component: memory
      phase: m5
    annotations:
      summary: "å†…å­˜ä½¿ç”¨ä¸¥é‡è¶…æ ‡"
      description: "RSSå†…å­˜ä½¿ç”¨é‡ {{ $value | humanize1024 }}B è¶…è¿‡80MBï¼Œç«‹å³éœ€è¦å…³æ³¨"
      
  # ğŸ”¥ W2: GC Performance Alerts (æ›´æ–°é˜ˆå€¼)
  - alert: GCGen2FrequencyHigh
    expr: rate(gc_collections_total{generation="2"}[10m]) > 1  # é™ä½é˜ˆå€¼ï¼ŒW2ååº”å‡ ä¹æ— Gen2
    for: 5m
    labels:
      severity: critical  # æå‡ä¸¥é‡çº§åˆ«
      component: gc_gen2
      phase: m5_w2
    annotations:
      summary: "GC Gen2å›æ”¶é¢‘ç‡è¿‡é«˜(W2å)"
      description: "Gen2å›æ”¶é¢‘ç‡ {{ $value }}/10minï¼ŒW2ä¼˜åŒ–ååº”æ¥è¿‘0"
      
  - alert: GCGen0FrequencyExtreme  
    expr: rate(gc_collections_total{generation="0"}[1m]) > 1  # é™ä½é˜ˆå€¼ï¼ŒW2ååº”å‡ ä¹æ— Gen0
    for: 3m
    labels:
      severity: critical
      component: gc_gen0
      phase: m5_w2
    annotations:
      summary: "GC Gen0å›æ”¶é¢‘ç‡å¼‚å¸¸(W2å)"
      description: "Gen0å›æ”¶é¢‘ç‡ {{ $value }}/minï¼ŒW2ä¼˜åŒ–ååº”æ¥è¿‘0"
      
  - alert: GCCollectionEfficiencyLow
    expr: (rate(gc_collected_objects_total[5m]) / rate(gc_collections_total[5m])) < 5
    for: 10m
    labels:
      severity: warning
      component: gc_efficiency  
      phase: m5_w2
    annotations:
      summary: "GCå›æ”¶æ•ˆç‡ä½ä¸‹"
      description: "å¹³å‡æ¯æ¬¡GCå›æ”¶å¯¹è±¡æ•° {{ $value }} < 5ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼"
      
  # Memory Allocation Rate Alerts  
  - alert: MemoryAllocationRateHigh
    expr: memory_allocation_rate_per_second > 100
    for: 5m
    labels:
      severity: warning
      component: memory_allocation
      phase: m5_w2
    annotations:
      summary: "å†…å­˜åˆ†é…ç‡è¿‡é«˜"
      description: "å†…å­˜åˆ†é…ç‡ {{ $value }}/sec è¶…è¿‡100ï¼Œä¼˜åŒ–æ•ˆæœé€€åŒ–"
      
  # Cache Performance Degradation
  - alert: CacheHitRateDropped
    expr: cache_hit_rate{cache_type="ma"} < 80 
    for: 5m
    labels:
      severity: critical
      component: cache_regression
      phase: m5_w2  
    annotations:
      summary: "ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™"
      description: "MAç¼“å­˜å‘½ä¸­ç‡ {{ $value }}% ä½äº80%ï¼ŒW1ä¼˜åŒ–æ•ˆæœé€€åŒ–"
      
  # ğŸ”¥ W2: æ›´ä¸¥æ ¼çš„GCæš‚åœæ—¶é—´å‘Šè­¦
  - alert: GCPauseTimeHigh
    expr: histogram_quantile(0.95, gc_pause_duration_seconds) > 0.05  # 50msï¼ŒW2åçš„ä¸¥æ ¼é˜ˆå€¼
    for: 1m  # æ›´å¿«å“åº”
    labels:
      severity: critical
      component: gc
      phase: m5_w2
    annotations:
      summary: "GCæš‚åœæ—¶é—´è¶…è¿‡W2é˜ˆå€¼"
      description: "GCæš‚åœæ—¶é—´P95 {{ $value }}s è¶…è¿‡50ms W2é˜ˆå€¼ï¼Œä¼˜åŒ–å¤±æ•ˆ"
      
  - alert: GCPauseTimeWarning
    expr: histogram_quantile(0.95, gc_pause_duration_seconds) > 0.01  # 10msè­¦å‘Šé˜ˆå€¼
    for: 5m
    labels:
      severity: warning
      component: gc
      phase: m5_w2
    annotations:
      summary: "GCæš‚åœæ—¶é—´è­¦å‘Š"
      description: "GCæš‚åœæ—¶é—´P95 {{ $value }}s è¶…è¿‡10msï¼Œæ¥è¿‘W2é˜ˆå€¼"
      
  # File Descriptor Leak Detection
  - alert: FDLeakDetected
    expr: increase(process_open_fds[5m]) > 50
    for: 3m
    labels:
      severity: warning
      component: fd_leak
      phase: m5
    annotations:
      summary: "æ£€æµ‹åˆ°æ–‡ä»¶æè¿°ç¬¦æ³„æ¼"
      description: "5åˆ†é’Ÿå†…æ–‡ä»¶æè¿°ç¬¦å¢é•¿ {{ $value }}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ³„æ¼"
      
  - alert: FDCountHigh
    expr: process_open_fds > 800
    for: 1m
    labels:
      severity: critical
      component: fd_leak
      phase: m5
    annotations:
      summary: "æ–‡ä»¶æè¿°ç¬¦æ•°é‡è¿‡é«˜"
      description: "å½“å‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡ {{ $value }}ä¸ªï¼Œè¶…è¿‡800é˜ˆå€¼"
      
  # Memory Growth Rate Alerts
  - alert: MemoryGrowthHigh
    expr: memory_growth_rate_mb_per_minute > 0.5
    for: 10m
    labels:
      severity: warning
      component: memory_leak
      phase: m5
    annotations:
      summary: "å†…å­˜å¢é•¿ç‡è¿‡é«˜"
      description: "å†…å­˜å¢é•¿ç‡ {{ $value }}MB/åˆ†é’Ÿï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼"
      
  # Trading System Performance
  - alert: TradingLatencyHigh
    expr: histogram_quantile(0.95, task_latency_seconds{task_type="trading_cycle"}) > 0.0055
    for: 5m
    labels:
      severity: warning
      component: performance
      phase: m5
    annotations:
      summary: "äº¤æ˜“å»¶è¿Ÿè¿‡é«˜"
      description: "äº¤æ˜“å¤„ç†å»¶è¿ŸP95 {{ $value }}s è¶…è¿‡5.5ms W4é˜ˆå€¼"
      
  # WebSocket Health
  - alert: WebSocketReconnectHigh
    expr: rate(ws_reconnects_total[5m]) > 0.1
    for: 3m
    labels:
      severity: warning
      component: websocket
      phase: m5
    annotations:
      summary: "WebSocketé‡è¿é¢‘ç‡è¿‡é«˜"
      description: "WebSocketé‡è¿é¢‘ç‡ {{ $value }}/ç§’ï¼Œå¯èƒ½å­˜åœ¨è¿æ¥é—®é¢˜"

- name: m5_business_alerts
  rules:
  # Cache Performance
  - alert: CacheHitRateLow
    expr: (trading_api_calls_total{endpoint="cache_ma_hit_rate"} / 100) < 0.8
    for: 10m
    labels:
      severity: warning
      component: cache
      phase: m5
    annotations:
      summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
      description: "MAç¼“å­˜å‘½ä¸­ç‡ {{ $value }}% ä½äº80%ï¼Œå½±å“æ€§èƒ½"
      
  # Signal Processing Rate
  - alert: SignalProcessingSlowed
    expr: rate(trading_signal_latency_seconds_count[5m]) < 10
    for: 5m
    labels:
      severity: warning
      component: signal_processing
      phase: m5
    annotations:
      summary: "ä¿¡å·å¤„ç†é€Ÿåº¦ä¸‹é™"
      description: "ä¿¡å·å¤„ç†é€Ÿåº¦ {{ $value }}/ç§’ ä½äºé¢„æœŸ"

- name: m5_system_health
  rules:
  # CPU Usage
  - alert: CPUUsageHigh
    expr: process_cpu_percent > 80
    for: 5m
    labels:
      severity: warning
      component: cpu
      phase: m5
    annotations:
      summary: "CPUä½¿ç”¨ç‡è¿‡é«˜"
      description: "è¿›ç¨‹CPUä½¿ç”¨ç‡ {{ $value }}% è¶…è¿‡80%"
      
  # System Memory Pressure
  - alert: SystemMemoryPressure
    expr: process_memory_percent > 10
    for: 10m
    labels:
      severity: warning
      component: system_memory
      phase: m5
    annotations:
      summary: "ç³»ç»Ÿå†…å­˜å‹åŠ›"
      description: "è¿›ç¨‹å ç”¨ç³»ç»Ÿå†…å­˜ {{ $value }}%ï¼Œå¯èƒ½å½±å“å…¶ä»–è¿›ç¨‹"
      
  # Thread Count
  - alert: ThreadCountHigh
    expr: thread_count > 50
    for: 5m
    labels:
      severity: warning
      component: threading
      phase: m5
    annotations:
      summary: "çº¿ç¨‹æ•°é‡è¿‡å¤š"
      description: "å½“å‰çº¿ç¨‹æ•°é‡ {{ $value }}ä¸ªï¼Œå¯èƒ½å­˜åœ¨çº¿ç¨‹æ³„æ¼"

- name: m5_prometheus_health
  rules:
  # Prometheus Metrics Availability
  - alert: PrometheusMetricsMissing
    expr: up{job="trading_system"} == 0
    for: 1m
    labels:
      severity: critical
      component: monitoring
      phase: m5
    annotations:
      summary: "PrometheusæŒ‡æ ‡ä¸å¯ç”¨"
      description: "äº¤æ˜“ç³»ç»ŸPrometheusæŒ‡æ ‡ç«¯ç‚¹ä¸å¯è¾¾"
      
  # Metric Collection Rate
  - alert: MetricCollectionSlowed
    expr: rate(prometheus_notifications_total[5m]) < 1
    for: 5m
    labels:
      severity: warning
      component: monitoring
      phase: m5
    annotations:
      summary: "æŒ‡æ ‡æ”¶é›†é€Ÿåº¦ä¸‹é™"
      description: "PrometheusæŒ‡æ ‡æ”¶é›†é€Ÿåº¦å¼‚å¸¸"

- name: m5_w4_validation
  rules:
  # W4 Validation Rules for 24h Stress Test
  - alert: W4_RSS_Threshold_Exceeded
    expr: process_memory_rss_bytes > 40 * 1024 * 1024
    for: 1m
    labels:
      severity: critical
      component: w4_validation
      phase: m5
      test_type: stress_canary
    annotations:
      summary: "W4éªŒæ”¶å¤±è´¥ - RSSè¶…è¿‡40MB"
      description: "24å°æ—¶å‹åŠ›æµ‹è¯•æœŸé—´RSS {{ $value | humanize1024 }}B è¶…è¿‡40MBé˜ˆå€¼"
      
  - alert: W4_GC_Pause_Exceeded
    expr: histogram_quantile(0.95, gc_pause_duration_seconds) > 0.05
    for: 1m
    labels:
      severity: critical
      component: w4_validation
      phase: m5
      test_type: stress_canary
    annotations:
      summary: "W4éªŒæ”¶å¤±è´¥ - GCæš‚åœè¶…è¿‡50ms"
      description: "24å°æ—¶å‹åŠ›æµ‹è¯•æœŸé—´GCæš‚åœP95 {{ $value }}s è¶…è¿‡50msé˜ˆå€¼"
      
  - alert: W4_Latency_Regression
    expr: histogram_quantile(0.95, task_latency_seconds{task_type="trading_cycle"}) > 0.0055
    for: 2m
    labels:
      severity: warning
      component: w4_validation
      phase: m5
      test_type: stress_canary
    annotations:
      summary: "W4éªŒæ”¶è­¦å‘Š - å»¶è¿Ÿåå¼¹"
      description: "äº¤æ˜“å»¶è¿ŸP95 {{ $value }}s è¶…è¿‡5.5msï¼Œå¯èƒ½å‘ç”Ÿæ€§èƒ½å›é€€"
      
  - alert: W4_FD_Leak_Critical
    expr: process_open_fds > 500
    for: 1m
    labels:
      severity: critical
      component: w4_validation
      phase: m5
      test_type: stress_canary
    annotations:
      summary: "W4éªŒæ”¶å¤±è´¥ - FDæ•°é‡è¶…æ ‡"
      description: "æ–‡ä»¶æè¿°ç¬¦æ•°é‡ {{ $value }}ä¸ª è¶…è¿‡500é˜ˆå€¼"

- name: m5_leak_detection
  rules:
  # Continuous Leak Detection for W3
  - alert: W3_Memory_Leak_Detected
    expr: memory_growth_rate_mb_per_minute > 0.1
    for: 30m
    labels:
      severity: critical
      component: w3_validation
      phase: m5
      test_type: leak_sentinel
    annotations:
      summary: "W3éªŒæ”¶å¤±è´¥ - æ£€æµ‹åˆ°å†…å­˜æ³„æ¼"
      description: "è¿ç»­30åˆ†é’Ÿå†…å­˜å¢é•¿ç‡ {{ $value }}MB/åˆ†é’Ÿï¼Œè¶…è¿‡é˜ˆå€¼"
      
  - alert: W3_FD_Leak_Detected
    expr: fd_growth_rate_per_minute > 0.1
    for: 20m
    labels:
      severity: warning
      component: w3_validation
      phase: m5
      test_type: leak_sentinel
    annotations:
      summary: "W3è­¦å‘Š - FDå¢é•¿å¼‚å¸¸"
      description: "æ–‡ä»¶æè¿°ç¬¦å¢é•¿ç‡ {{ $value }}/åˆ†é’Ÿï¼Œéœ€è¦å…³æ³¨"
      
  - alert: W3_Clean_Hours_Reset
    expr: increase(clean_hours_counter[1h]) == 0 and clean_hours_counter > 0
    for: 5m
    labels:
      severity: warning
      component: w3_validation
      phase: m5
      test_type: leak_sentinel
    annotations:
      summary: "W3æ¸…æ´å°æ—¶æ•°é‡ç½®"
      description: "æ¸…æ´å°æ—¶è®¡æ•°å™¨è¢«é‡ç½®ï¼Œæ³„æ¼æ£€æµ‹å‘ç°é—®é¢˜"

- name: m5_cache_optimization
  rules:
  # W1 Cache Performance Validation
  - alert: W1_Cache_Hit_Rate_Low
    expr: (trading_api_calls_total{endpoint="cache_ma_hit_rate"} / 100) < 0.6
    for: 15m
    labels:
      severity: warning
      component: w1_validation
      phase: m5
      test_type: cache_optimization
    annotations:
      summary: "W1ç¼“å­˜å‘½ä¸­ç‡ä½äºé¢„æœŸ"
      description: "MAç¼“å­˜å‘½ä¸­ç‡ {{ $value }}% ä½äº60%ï¼Œç¼“å­˜æ•ˆæœä¸ä½³"
      
  - alert: W1_Memory_Allocation_High
    expr: rate(memory_allocations_total[5m]) > 100
    for: 10m
    labels:
      severity: warning
      component: w1_validation
      phase: m5
      test_type: cache_optimization
    annotations:
      summary: "W1å†…å­˜åˆ†é…ç‡ä»ç„¶è¿‡é«˜"
      description: "å†…å­˜åˆ†é…ç‡ {{ $value }}/ç§’ é«˜äºé¢„æœŸï¼Œç¼“å­˜ä¼˜åŒ–å¯èƒ½ä¸å……åˆ†"

- name: m5_automation_alerts
  rules:
  # Automated Response Triggers
  - alert: AutoRestart_Memory_Critical
    expr: process_memory_rss_bytes > 100 * 1024 * 1024
    for: 30s
    labels:
      severity: critical
      component: automation
      phase: m5
      action: restart_required
    annotations:
      summary: "å†…å­˜ä½¿ç”¨ä¸¥é‡è¶…æ ‡ - éœ€è¦è‡ªåŠ¨é‡å¯"
      description: "RSSå†…å­˜ {{ $value | humanize1024 }}B è¶…è¿‡100MBï¼Œè§¦å‘è‡ªåŠ¨é‡å¯"
      
  - alert: AutoFallback_WebSocket_Failed
    expr: rate(ws_reconnects_total[2m]) > 1
    for: 1m
    labels:
      severity: warning
      component: automation
      phase: m5
      action: fallback_rest
    annotations:
      summary: "WebSocketè¿æ¥æŒç»­å¤±è´¥ - è‡ªåŠ¨åˆ‡æ¢REST"
      description: "WebSocketé‡è¿é¢‘ç‡è¿‡é«˜ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°REST APIæ¨¡å¼"
      
  - alert: AutoOptimize_GC_Performance
    expr: histogram_quantile(0.95, gc_pause_duration_seconds) > 0.2
    for: 5m
    labels:
      severity: warning
      component: automation
      phase: m5
      action: gc_optimize
    annotations:
      summary: "GCæ€§èƒ½å¼‚å¸¸ - è§¦å‘è‡ªåŠ¨ä¼˜åŒ–"
      description: "GCæš‚åœæ—¶é—´è¿‡é•¿ï¼Œè§¦å‘è‡ªåŠ¨GCå‚æ•°ä¼˜åŒ–" 